#!/usr/bin/env bash

############################################
# Defaults (can be overridden by CLI args)
############################################
PHP_CMD="php"
COMPOSER_CMD="composer"
GIT_REMOTE="origin"
MAIN_BRANCH="main"
MAIN_DEV_BRANCH="develop"
CONFIG_FILE="./config/app.php"
BRANCH_PREFIX="release/"
WITH_APP_VERSION_UPDATE=false
WITH_TESTS=true
WITH_COMPOSER_AUDIT=true
POST_RELEASE_UPDATE_BRANCHES=("${MAIN_DEV_BRANCH}")
COMMIT_MSG_TEMPLATE="Release v{{version}}"

parse_bool() {
  case "$1" in
    true|1|yes) echo true ;;
    false|0|no) echo false ;;
    *) return 1 ;;
  esac
}

############################################
# CLI argument parsing
############################################
for arg in "$@"; do
  case "$arg" in
    --php-cmd=*)
      PHP_CMD="${arg#*=}"
      ;;
    --composer-cmd=*)
      COMPOSER_CMD="${arg#*=}"
      ;;
    --git-remote-name=*)
      GIT_REMOTE="${arg#*=}"
      ;;
    --main-branch=*)
      MAIN_BRANCH="${arg#*=}"
      ;;
    --main-dev-branch=*)
      MAIN_DEV_BRANCH="${arg#*=}"
      ;;
    --release-branch-prefix=*)
      BRANCH_PREFIX="${arg#*=}"
      ;;
    --commit-msg-template=*)
      COMMIT_MSG_TEMPLATE="${arg#*=}"
      ;;
    --with-app-version-update=*)
      VALUE="${arg#*=}"
      if ! WITH_APP_VERSION_UPDATE=$(parse_bool "$VALUE"); then
        echo "Invalid boolean: ${arg#*=}"
        exit 1
      fi
      shift
      ;;
    --with-tests=*)
      VALUE="${arg#*=}"
      if ! WITH_TESTS=$(parse_bool "$VALUE"); then
        echo "Invalid boolean: $VALUE"
        exit 1
      fi
      shift
      ;;
    --with-composer-audit=*)
      VALUE="${arg#*=}"
      if ! WITH_COMPOSER_AUDIT=$(parse_bool "$VALUE"); then
        echo "Invalid boolean: $VALUE"
        exit 1
      fi
      shift
      ;;
    --post-release-update-branches=*)
      VALUE="${arg#*=}"

      IFS=',' read -r -a POST_RELEASE_UPDATE_BRANCHES <<< "$VALUE"

      shift
      ;;
    *)
      echo -e "${RED}Unknown argument: $arg${RESET}"
      exit 1
      ;;
  esac
done

# helper colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
RESET='\033[0m'

# helper: print and run, returning status
run() {
  echo -e "${YELLOW}+ $*${RESET}"
  eval "$@"
  return $?
}

fail() {
  echo -e "${RED}âœ– $*${RESET}"
  exit 1
}

info() {
  echo -e "${GREEN}â†’ $*${RESET}"
}

if eval "${PHP_CMD} --version" >/dev/null 2>&1; then
  PHP_VERSION_OUTPUT=$(eval "${PHP_CMD} --version" 2>/dev/null | head -n1)
  PHP_VERSION=$(echo "${PHP_VERSION_OUTPUT}" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' || true)
  if [ -n "${PHP_VERSION}" ]; then
    info "Using PHP command: ${PHP_CMD} (version ${PHP_VERSION})"
  else
    info "Using PHP command: ${PHP_CMD}"
  fi
else
  fail "PHP executable or wrapper not found or not executable: ${PHP_CMD}. Export PHP_CMD to point to your sail/php script if necessary."
fi

if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
  fail "Not inside a git repository."
fi

if ! git diff --quiet || ! git diff --staged --quiet; then
  echo -e "${YELLOW}Warning: You have uncommitted changes. It's recommended to start from a clean working tree.${RESET}"
  read -p "Continue anyway? [y/N]: " cont
  case "$cont" in
    [Yy]*) ;;
    *) fail "Aborting."; ;;
  esac
fi

info "Switching to ${MAIN_DEV_BRANCH} and pulling latest..."
if git rev-parse --verify "$MAIN_DEV_BRANCH" >/dev/null 2>&1; then
  run "git checkout ${MAIN_DEV_BRANCH}" || fail "Cannot switch to ${MAIN_DEV_BRANCH}"
else
  run "git switch -c ${MAIN_DEV_BRANCH}" || run "git checkout -b ${MAIN_DEV_BRANCH}" || fail "Failed to create/switch to ${MAIN_DEV_BRANCH}"
fi
run "git pull ${GIT_REMOTE} ${MAIN_DEV_BRANCH}" || fail "Failed to pull ${MAIN_DEV_BRANCH} from ${GIT_REMOTE}"

if [[ "$WITH_TESTS" == true ]]; then
  info "Running tests"
  run "${PHP_CMD} artisan test --compact" || fail "Tests failed"
fi

if [[ "$WITH_COMPOSER_AUDIT" == true ]]; then
  info "Checking composer dependencies (composer audit)"
  run "${COMPOSER_CMD} audit" || fail "Composer audit reported issues"
fi

echo
read -p "Enter release version (eg. 1.0.0): " VERSION
VERSION="${VERSION// /}" # trim spaces
if [ -z "$VERSION" ]; then
  fail "No version provided, aborting."
fi

info "Fetching tags from ${GIT_REMOTE}..."
run "git fetch --tags ${GIT_REMOTE}" || fail "Failed to fetch tags"

if git rev-parse "refs/tags/${VERSION}" >/dev/null 2>&1; then
  fail "Tag '${VERSION}' already exists locally."
fi
if git ls-remote --tags "${GIT_REMOTE}" | grep -E "refs/tags/${VERSION}$" >/dev/null 2>&1; then
  fail "Tag '${VERSION}' already exists on remote ${GIT_REMOTE}."
fi

RELEASE_BRANCH="${BRANCH_PREFIX}${VERSION}"
info "Creating branch ${RELEASE_BRANCH}..."
run "git checkout -b ${RELEASE_BRANCH}" || fail "Failed to create branch ${RELEASE_BRANCH}"

if [[ "$WITH_APP_VERSION_UPDATE" == true ]]; then
  info "Updating version in ${CONFIG_FILE} to ${VERSION}..."
  if [ ! -f "${CONFIG_FILE}" ]; then
    fail "Config file '${CONFIG_FILE}' not found."
  fi

  run "sed -E -i.bak \"s/(['\\\"]version['\\\"]\\s*=>\\s*['\\\"])[^'\\\"]+(['\\\"])/\\1${VERSION}\\2/\" \"${CONFIG_FILE}\"" || {
    # restore backup if something went wrong
    [ -f "${CONFIG_FILE}.bak" ] && mv "${CONFIG_FILE}.bak" "${CONFIG_FILE}"
    fail "Failed to update ${CONFIG_FILE}"
  }

  rm -f "${CONFIG_FILE}.bak"

  info "Staging ${CONFIG_FILE}..."
  run "git add \"${CONFIG_FILE}\"" || fail "git add failed"
fi

if ! git diff --quiet || ! git diff --staged --quiet; then
  COMMIT_MSG="${COMMIT_MSG_TEMPLATE//\{\{version\}\}/${VERSION}}"
  info "Committing changes: ${COMMIT_MSG}"
  run "git commit -m \"${COMMIT_MSG}\" --no-verify" || fail "git commit failed"
fi

info "Pushing branch ${RELEASE_BRANCH} to ${GIT_REMOTE}..."
run "git push -u ${GIT_REMOTE} ${RELEASE_BRANCH}" || fail "git push failed"

RELEASE_COMMIT=$(git rev-parse "${RELEASE_BRANCH}")

echo
info "When you finish creating and merging the Merge/Pull Request, press any key to continue..."
read -n1 -s -r -p "Press any key when merged (or Ctrl+C to abort)..." ; echo

while true; do
  info "Fetching ${MAIN_BRANCH} from ${GIT_REMOTE}..."
  run "git fetch ${GIT_REMOTE} ${MAIN_BRANCH}" || fail "Failed to fetch ${MAIN_BRANCH}"

  run "git switch ${MAIN_BRANCH}" || run "git checkout ${MAIN_BRANCH}" || fail "Cannot switch to ${MAIN_BRANCH}"
  run "git pull ${GIT_REMOTE} ${MAIN_BRANCH}" || fail "Failed to pull ${MAIN_BRANCH}"

  if git merge-base --is-ancestor "${RELEASE_COMMIT}" HEAD; then
    info "Release branch '${RELEASE_BRANCH}' has been merged into ${MAIN_BRANCH}."
    break
  fi

  echo
  echo -e "${YELLOW}Release branch not merged into ${MAIN_BRANCH} yet.${RESET}"
  read -p "Merge the MR/PR and press any key to re-check (Ctrl+C to abort)..." -n1 -s
  echo
done

info "Creating annotated tag '${VERSION}' on ${MAIN_BRANCH} (this will open your git editor for message)..."

run "git switch ${MAIN_BRANCH}" || fail "Cannot switch to ${MAIN_BRANCH}"
run "git pull ${GIT_REMOTE} ${MAIN_BRANCH}" || fail "Failed to pull ${MAIN_BRANCH}"

CHANGELOG=$(git log "${FROM_REF}..${TO_REF}" \
  --pretty=format:'%h | %s' \
  --no-merges \
  --reverse \
| awk '
  {
    key="NO_TICKET_" NR
    if (match($0, /\[[A-Z]+-[0-9]+\]/)) {
      key=substr($0, RSTART+1, RLENGTH-2)
    }
    if (!(key in seen)) {
      seen[key]=1
      print "- " $0
    }
  }
')

TMP_TAG_DESC=$(mktemp)

{
  echo "Release ${VERSION}"
  echo
  echo "Changes:"
  echo
  echo "${CHANGELOG}"
} > "${TMP_TAG_DESC}"

run "git tag -a \"${VERSION}\" -F \"${TMP_TAG_DESC}\"" || fail "Failed to create tag ${VERSION}"

rm -f "${TMP_TAG_DESC}"

info "Pushing tag '${VERSION}' to ${GIT_REMOTE}..."
run "git push ${GIT_REMOTE} \"refs/tags/${VERSION}\"" || fail "Failed to push tag ${VERSION}"

echo
echo -e "${GREEN}Release ${VERSION} completed successfully! ðŸŽ‰${RESET}"
echo -e "${GREEN}Tag '${VERSION}' pushed. ${RESET}"

info "Post release branches update from ${MAIN_BRANCH}..."

run "git fetch ${GIT_REMOTE} ${MAIN_BRANCH}" || fail "Failed to fetch branches"
run "git switch ${MAIN_BRANCH}" || run "git checkout ${MAIN_BRANCH}" || fail "Cannot switch to ${MAIN_BRANCH}"
run "git pull ${GIT_REMOTE} ${MAIN_BRANCH}" || fail "Failed to pull ${MAIN_BRANCH}"

for sync_branch in "${POST_RELEASE_UPDATE_BRANCHES[@]}"; do
  if git rev-parse --verify "$sync_branch" >/dev/null 2>&1; then
    run "git switch $sync_branch" || run "git checkout $sync_branch" || fail "Cannot switch to $sync_branch"
    run "git pull ${GIT_REMOTE} $sync_branch" || fail "Failed to pull $sync_branch"
  fi

  run "git switch $sync_branch" || run "git checkout $sync_branch" || fail "Cannot switch to $sync_branch"
  run "git merge ${GIT_REMOTE}/$sync_branch" || fail "Failed to merge ${MAIN_BRANCH} into $sync_branch"
  run "git push ${GIT_REMOTE} $sync_branch" || fail "Failed to push $sync_branch"
done
